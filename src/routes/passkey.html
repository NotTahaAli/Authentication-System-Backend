<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>

<body>
    <button id="btnBegin">Register PassKey</button>
    <span id="success"></span>
    <span id="error"></span>

    <form action="?" method="POST" id="regForm" onsubmit="return false">
        <div class="g-recaptcha" data-sitekey="6LeGhRUqAAAAAGa2zZwSdqwlYVPyCplxasSQisUd"></div>
        <br />
        <input type="text" id="username" placeholder="Username">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <input type="number" id="2FACode" placeholder="XXXXXX">
        <button onclick="formSubmitted()">Signup</button>
        <button onclick="logFormSubmitted()">Login</button>
        <button onclick="loginUsingPassKey()">Login Using Passkey</button>
        <button onclick="verifyEmail()">Verify Email</button>
        <button onclick="resetPassword()">Reset Password</button>
        <button onclick="twoFactor()">Two Factor</button>
    </form>

    <script>
        const form = document.getElementById("regForm");
        function formSubmitted() {
            try {

                fetch("/auth/sign-up", {
                    body: JSON.stringify({
                        token: grecaptcha.getResponse(),
                        username: document.getElementById('username').value,
                        email: document.getElementById('email').value,
                        password: document.getElementById('password').value
                    }),
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    }
                }).then(async (resp) => {
                    grecaptcha.reset();
                    if (resp.ok) {
                        localStorage.setItem("jwt", resp.headers.get("Authorization"))
                        console.log(resp.headers.get("Authorization"))
                    } else {
                        console.log(await resp.json())
                    }
                }).catch((err) => {
                    console.log(err);
                })
            } catch (err) {
                console.log(err);
            }
            return false;
        }

        function logFormSubmitted() {
            try {

                fetch("/auth/login", {
                    body: JSON.stringify({
                        token: grecaptcha.getResponse(),
                        username: document.getElementById('username').value,
                        password: document.getElementById('password').value
                    }),
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    }
                }).then(async (resp) => {
                    grecaptcha.reset();
                    if (resp.ok) {
                        localStorage.setItem("jwt", resp.headers.get("Authorization"))
                        console.log(resp.headers.get("Authorization"))
                    } else {
                        if (resp.headers.get("TwoFactorCode")) {
                            localStorage.setItem("2fa",resp.headers.get("TwoFactorCode"));
                            console.log(resp.headers.get("TwoFactorCode"));
                        }
                        console.log(await resp.json())
                    }
                }).catch((err) => {
                    console.log(err);
                })
            } catch (err) {
                console.log(err);
            }
            return false;
        }

        function verifyEmail() {
            try {
                fetch("/auth/verify", {
                    body: JSON.stringify({
                        token: grecaptcha.getResponse(),
                        email: document.getElementById('email').value,
                    }),
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    }
                }).then(async (resp) => {
                    grecaptcha.reset();
                    if (resp.ok) {
                        console.log("Email Link sent if exists")
                    } else {
                        console.log(await resp.json())
                    }
                }).catch((err) => {
                    console.log(err);
                })
            } catch (err) {
                console.log(err);
            }
            return false;
        }

        function resetPassword() {
            try {
                fetch("/auth/reset-password", {
                    body: JSON.stringify({
                        token: grecaptcha.getResponse(),
                        email: document.getElementById('email').value,
                    }),
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    }
                }).then(async (resp) => {
                    grecaptcha.reset();
                    if (resp.ok) {
                        console.log("Email Link sent if exists")
                    } else {
                        console.log(await resp.json())
                    }
                }).catch((err) => {
                    console.log(err);
                })
            } catch (err) {
                console.log(err);
            }
            return false;
        }

        function twoFactor() {
            try {
                fetch("/auth/two-factor", {
                    body: JSON.stringify({
                        token: grecaptcha.getResponse(),
                        code: parseInt(document.getElementById('2FACode').value),
                    }),
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "TwoFactorCode": localStorage.getItem("2fa")
                    }
                }).then(async (resp) => {
                    grecaptcha.reset();
                    if (resp.ok) {
                        localStorage.setItem("jwt", resp.headers.get("Authorization"))
                        console.log(resp.headers.get("Authorization"))
                    } else {
                        console.log(await resp.json())
                    }
                }).catch((err) => {
                    console.log(err);
                })
            } catch (err) {
                console.log(err);
            }
            return false;
        }

        const { startRegistration, startAuthentication } = SimpleWebAuthnBrowser;

        // <button>
        const elemBegin = document.getElementById('btnBegin');
        const elemCheck = document.getElementById('btnCheck');
        // <span>/<p>/etc...
        const elemSuccess = document.getElementById('success');
        // <span>/<p>/etc...
        const elemError = document.getElementById('error');

        // Start registration when the user clicks a button
        elemBegin.addEventListener('click', async () => {
            // Reset success/error messages
            elemSuccess.innerHTML = '';
            elemError.innerHTML = '';
            // GET registration options from the endpoint that calls
            // @simplewebauthn/server -> generateRegistrationOptions()
            const resp = await fetch('/authn/register/generate-options', {
                headers: {
                    "authorization": localStorage.getItem("jwt")
                }
            });

            let attResp;
            try {
                // Pass the options to the authenticator and wait for a response
                const data = await resp.json();
                console.log(data);
                const message = data.message;
                attResp = await startRegistration(message);
            } catch (error) {
                // Some basic error handling
                if (error.name === 'InvalidStateError') {
                    elemError.innerText = 'Error: Authenticator was probably already registered by user';
                } else {
                    elemError.innerText = error;
                }

                throw error;
            }

            const verificationResp = await fetch('/authn/register/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'webauthn_options': resp.headers.get("webauthn_options"),
                    "authorization": localStorage.getItem("jwt")
                },
                body: JSON.stringify(attResp),
            });

            // Wait for the results of verification
            const verificationJSON = await verificationResp.json().message;

            // Show UI appropriate for the `verified` status
            if (verificationJSON && verificationJSON.verified) {
                elemSuccess.innerHTML = 'Success!';
            } else {
                elemError.innerHTML = `Oh no, something went wrong! Response: <pre>${JSON.stringify(
                    verificationJSON,
                )}</pre>`;
            }
        });

        async function loginUsingPassKey() {
            // Reset success/error messages
            elemSuccess.innerHTML = '';
            elemError.innerHTML = '';
            // GET registration options from the endpoint that calls
            // @simplewebauthn/server -> generateRegistrationOptions()
            const resp = await fetch('/authn/auth/get-options', {
                headers: {
                    "authorization": localStorage.getItem("jwt"),
                    "Content-Type": "application/json"
                },
                method: "POST",
                body: JSON.stringify({
                    username: document.getElementById("username").value
                })
            });

            let attResp;
            try {
                // Pass the options to the authenticator and wait for a response
                const data = await resp.json();
                console.log(data);
                if (data.error) {
                    throw data.error;
                }
                const message = data.message;
                attResp = await startAuthentication(message);
            } catch (error) {
                // Some basic error handling
                if (error.name === 'InvalidStateError') {
                    elemError.innerText = 'Error: Authenticator was probably already registered by user';
                } else {
                    elemError.innerText = error;
                }

                throw error;
            }

            const verificationResp = await fetch('/authn/auth/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'webauthn_options': resp.headers.get("webauthn_options")
                },
                body: JSON.stringify(attResp),
            });

            // Wait for the results of verification
            const data = await verificationResp.json();
            const verificationJSON = data.message;

            // Show UI appropriate for the `verified` status
            if (verificationJSON && verificationJSON.verified) {
                localStorage.setItem("jwt", verificationResp.headers.get("Authorization"))
                console.log(verificationResp.headers.get("Authorization"));
                elemSuccess.innerHTML = 'Success!';
            } else {
                elemError.innerHTML = `Oh no, something went wrong! Response: <pre>${data.error}</pre>`;
            }
        };
    </script>
</body>

</html>